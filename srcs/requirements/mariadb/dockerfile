FROM    debian:bullseye

RUN     apt-get update -y && apt-get upgrade -y && \
        apt-get install mariadb-server mariadb-client -y && \
        mkdir -p /var/run/mysqld && \
        chown -R mysql:mysql /var/run/mysqld && chown -R mysql:mysql /etc/mysql/

COPY    tools/createDB.sh /tmp/
COPY    tools/init.sql /tmp/
COPY    tools/mysql.cnf /etc/mysql

RUN     chown -R mysql:mysql /tmp/ && \
        chown -R mysql:mysql /etc/mysql

# Crear un script para inicializar MariaDB
RUN echo '#!/bin/bash\n\
# Eliminar archivos de registro de InnoDB\n\
rm -f /var/lib/mysql/ib_logfile0 /var/lib/mysql/ib_logfile1\n\
# Establecer el motor de almacenamiento por defecto a MyISAM\n\
echo "[mysqld]\n\
default-storage-engine=MyISAM" >> /etc/mysql/my.cnf\n\
# Ejecutar el script de creaciÃ³n de la base de datos\n\
exec /tmp/createDB.sh' > /tmp/init-mariadb.sh && \
chmod +x /tmp/init-mariadb.sh

USER    mysql

EXPOSE 3306

ENTRYPOINT ["sh", "/tmp/createDB.sh"]